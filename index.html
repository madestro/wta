<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.dot {
  stroke: #000;
}

.world {
  fill: none;
  stroke: #cccccc;
}

.countries {
  fill: none;
  stroke: #aaaaaa;
  stroke-linejoin: round;
}

.q0 { fill:rgb(255,255,255); }
.q1 { fill:rgb(222,235,247); }
.q2 { fill:rgb(198,219,239); }
.q3 { fill:rgb(158,202,225); }
.q4 { fill:rgb(107,174,214); }
.q5 { fill:rgb(66,146,198); }
.q6 { fill:rgb(33,113,181); }
.q7 { fill:rgb(8,81,156); }
.q8 { fill:rgb(8,48,107); }
.q9 { fill:rgb(8,8,57); }

</style>
<body>
<h1>WTA trends</h1>
<div id="plots">
<h2>There is some physical trend in top-100 players?</h2>
<div id="plot1"></div>
<div id="plot2"></div>
<div id="plot3"></div>
<div id="plot4"></div>
<div id="plot5"></div>
</div>
<div id="ranking">
<h2>Top-100 Ranking trends</h2>
<div id="plotboxes"></div>
<h2>Top-100 Ranking trends against top-10 trends (in gray)</h2>
<h3>(Use above plot for navigating)</h3>
<div id="rank"></div>
</div>
<div id="map">
<h2>There is some geographical trend in top-100 players?</h2>
<div id="wtamap" width=100%>
</div>
<h2>WTA head-to-head</h2>
<div id="h2h">
</div>
<h1>Disclaimer</h1>
<p>
There are trends in top-100 WTA players? how they behave in their careers?
what would be the key points to say: "this one will be a star"?<br>
I tried to answer that using public data from WTA website (before Wimbledon 2016!) as part of my
research visit at <a href=http://www.scalefreelabs.co>ScaleFreeLabs</a>,
where I was learning about dataviz with my friend and expert Dr. Alvaro Graves(<a href=http://www.twitter.com/alvarograves>@alvarograves</a>).
He told me that for practise I have to use public data from a subject that 
passionated me and that I could understand.<br>
Questions and comments are welcome via <a href=http://www.twitter.com/madestro>Twitter</a>.
</p>

<script src="js/d3.v4.min.js"></script>
<script src="js/d3-scale-chromatic.v1.min.js"></script>
<script src="js/topojson.v1.min.js"></script>

<script>
var color = d3.scaleOrdinal(d3.schemeSet1);

var winWidth = parseInt(d3.select('body').style('width'), 10) - 20;
var margin = {top: 20, right: 100, bottom: 20, left: 50};
var width = winWidth - margin.left - margin.right;
var height = 100 - margin.top - margin.bottom;
var x = d3.scaleLinear().domain([101,0]).range([0, width]);
var xr = d3.scaleLinear().domain([1995,2016]).clamp(true).rangeRound([0, width]);
var y = d3.scaleLinear().domain([20,-20]).clamp(true).rangeRound([0,height]);
var y3 = d3.scaleLinear().domain([10,-10]).clamp(true).rangeRound([0,height]);
var y4 = d3.scaleLinear().domain([3,-3]).clamp(true).rangeRound([0,height]);
var xAxis = d3.axisBottom(x);
var xrAxis = d3.axisBottom(xr);

var svg = new Array();
svg[0] = initcanvas("#plot5",110);
svg[1] = initcanvas("#plot1",110);
svg[2] = initcanvas("#plot2",110);
svg[3] = initcanvas("#plot4",110);
svg[4] = initcanvas("#plot3",110);

height = 400 - margin.top - margin.bottom;
var yr = d3.scaleLinear().domain([0,1000]).clamp(true).rangeRound([0,height]);
var yrAxis = d3.axisLeft(yr).ticks(5).tickFormat(d3.format(",.0f"));
var svgRank = initcanvas("#rank",400);

plays = [
"Right-handed (two-handed backhand)",
"Right-handed (one-handed backhand)",
"Right-handed (two-handed both sides)",
"Left-handed (two-handed backhand)",
"Left-handed (one-handed backhand)",
"Left-handed (two-handed both sides)"
];

d3.json("json/wta.json", function(error, data) {
  if (error) throw error;

  data = data.filter(function(d) {return d.rank[0] <= 100;});
  data.sort(function(a, b) {return a.rank[0] - b.rank[0];});
  for (key in data) {
    data[key].top10 = 0;
      if (data[key].rank[0] <= 10) data[key].top10 = 1;
    data[key].plays = plays.indexOf(data[key].plays);
    data[key].age = getAge(data[key].birthdate);
    data[key].bmi = Math.round((data[key].weight == 0)? 0:1000000*data[key].weight/(data[key].height*data[key].height))/100;
  }

  draw(data,"height","cm",y,1);
  draw(data,"weight","kg",y,2);
  draw(data,"bmi","kg/m2",y4,3);
  draw(data,"age","years",y3,4);

  drawPlay(data);

  drawMap(data);

  drawRank(data);

  drawH2H(data);
  });


  function initcanvas(divname,h) {
    var svg = d3.select(divname)
      .append('svg')
      .attr('width', '100%')
      .attr('height', h+'px')
      .append('g')
      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');
    svg.append('g')
      .attr('class', 'xaxis')
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);
    svg.append('g')
      .attr('class', 'yaxis')
    svg.append('text')
      .attr('class', 'xlabel')
      .attr('text-anchor', 'end')
      .attr('x', width)
      .attr('y', height+10)
      .text('rank');
    svg.append('text')
      .attr('class', 'ylabel')
      .attr('text-anchor', 'end')
      .attr('x', 0)
      .attr('y', -40)
      .attr('dy', '.75em')
      .attr("transform", "rotate(270)")
      .text('Y');

    return svg;
  }

function draw(data,key,metric,yf,idx) {
  var ordered = data.map(function(d) { return d[key]; }).sort();
  var median = ordered[50];
  var axis = d3.axisLeft(yf).ticks(5);

  svg[idx].selectAll(".ylabel")
      .text(key+"-median");
  svg[idx].selectAll(".yaxis")
      .call(axis);
  var dots = svg[idx].selectAll(".dot")
      .data(data)
    .enter();

  dots.append("circle")
      .attr("class", "dot")
      .attr("id", function(d) { return "dot"+d.id; })
      .attr("r", 3.5)
      .attr("cx", function(d) { return x(d.rank[0]); })
      .attr("cy", function(d) { return yf(d[key]-median);})
      .style("fill", color(idx))
      .on("mouseover", function(d) {
      d3.selectAll(".dot").style("opacity",0.15);
      d3.selectAll("#dot"+d.id).style("opacity",1);
    })
      .on("mouseout", function(d) {
      d3.selectAll(".dot").style("opacity",1);
    })
      .append("title")
      .text(function(d) { return d.rank[0]+": "+d.name+"\n"
                            +key+": "+d[key]+" "+metric;});
  dots.append("line")
    .attr("class", "dot")
      .attr("id", function(d) { return "dot"+d.id; })
    .attr("x1", function(d) { return x(d.rank[0]); })
    .attr("y1", function(d) { return yf(0); })
    .attr("x2", function(d) { return x(d.rank[0]); })
    .attr("y2", function(d) { return yf(d[key]-median); })
    .attr("stroke", color(idx))
    .attr("stroke-width", 1);

  drawMedian(svg[idx],median,metric,yf);
}

function drawPlay(data) {
  svg[0].selectAll(".ylabel")
      .text("plays");
  svg[0].selectAll(".yaxis").remove();

  var dots = svg[0].selectAll(".dot")
      .data(data)
    .enter();
  dots.append("circle")
      .attr("class", "dot")
      .attr("id", function(d) { return "dot"+d.id; })
      .attr("r", 3.5)
      .attr("cx", function(d) { return x(d.rank[0]); })
      .attr("cy", function(d) { return y(0); })
      .style("fill", function(d) { 
        return color(1+((d.plays > 2)? d.plays-3:d.plays)); 
      })
      .on("mouseover", function(d) {
      d3.selectAll(".dot").style("opacity",0.15);
      d3.selectAll("#dot"+d.id).style("opacity",1);
    })
      .on("mouseout", function(d) {
      d3.selectAll(".dot").style("opacity",1);
    })
      .append("title")
      .text(function(d) { return d.rank[0]+": "+d.name+"\nPlays: "+plays[d.plays];});
  dots.append("line")
    .attr("class", "dot")
    .attr("id", function(d) { return "dot"+d.id; })
    .attr("x1", function(d) { return x(d.rank[0]); })
    .attr("y1", function(d) { return y(0); })
    .attr("x2", function(d) { return x(d.rank[0]+((d.plays > 2)?-1:1)/2.5); })
    .attr("y2", function(d) { return y(-5); })
    .attr("stroke", function(d){ 
        return color(1+((d.plays > 2)? d.plays-3:d.plays));
      })
    .attr("stroke-width", 2);
  svg[0].append("circle")
    .attr("r", 3.5)
    .attr("cx", x(0))
    .attr("cy", y(20))
    .style("fill", color(1))
    .style("stroke", "black")
  svg[0].append("text")
    .text("two-handed backhand")
    .attr("class", "text-label")
    .attr("x", function(d) {return x(-1);})
    .attr("y", function(d) {return y(18);});
  svg[0].append("circle")
    .attr("r", 3.5)
    .attr("cx", x(0))
    .attr("cy", y(12))
    .style("fill", color(2))
    .style("stroke", "black")
  svg[0].append("text")
    .text("one-handed backhand")
    .attr("class", "text-label")
    .attr("x", function(d) {return x(-1);})
    .attr("y", function(d) {return y(10);});
  svg[0].append("circle")
    .attr("r", 3.5)
    .attr("cx", x(0))
    .attr("cy", y(4))
    .style("fill", color(3))
    .style("stroke", "black")
  svg[0].append("text")
    .text("two-handed both sides")
    .attr("class", "text-label")
    .attr("x", function(d) {return x(-1);})
    .attr("y", function(d) {return y(2);});


}

function getAge(dateString) 
{
    var today = new Date();
    var birthDate = new Date(dateString);
    var age = today.getFullYear() - birthDate.getFullYear();
    var m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) 
    {
        age--;
    }
    return age;
}

function drawMedian(svg,median,unit,y) {
var x1 = 1;
var y1 = 0;
var x2 = 100;
var y2 = 0;
var trendData = [[x1,y1,x2,y2]];
var trendline = svg.selectAll(".trendline").data(trendData);

trendline.enter()
.append("line")
.attr("class", "trendline")
.attr("x1", function(d) { return x(d[0]); })
.attr("y1", function(d) { return y(d[1]); })
.attr("x2", function(d) { return x(d[2]); })
.attr("y2", function(d) { return y(d[3]); })
.attr("stroke", "gray")
.attr("stroke-width", 1);

svg.append("text")
.text("median: " + median + " " + unit)
.attr("class", "text-label")
.attr("x", function(d) {return x(x1)+5;})
.attr("y", function(d) {return y(y1) - 5;});
}

function drawMap(wtadata) {

wtacountry = new Array();

var max = 0;

for (key in wtadata) {
  if (wtacountry[wtadata[key].country] === undefined) {
    wtacountry[wtadata[key].country] = 0;
  }
  wtacountry[wtadata[key].country]++;
  if (wtacountry[wtadata[key].country] > max ) {
    max = wtacountry[wtadata[key].country];
  }
}

var quantize = d3.scaleQuantize()
    .domain([0, 10])
    .range(d3.range(0,10).map(function(i) { return "q" + i; }));

var projection = d3.geoMercator()
                   .scale(200);

var path = d3.geoPath()
    .projection(projection);

var height = 500;

var svg = d3.select("#wtamap").append("svg")
    .attr("width", "100%")
    .attr("height", height)
    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')

d3.queue()
    .defer(d3.json, "json/world.json")
    .await(ready);

function ready(error, world) {
  if (error) console.log(error);
  svg.append("g")
       .attr("class", "world")
       .selectAll("path")
       .data(topojson.feature(world, world.objects.countries).features)
      .enter()
       .append("path")
       .attr("class", function(d) { 

         if (wtacountry[d.properties.name] === undefined) { return "q"+0; }
         else {
           return quantize(wtacountry[d.properties.name]);
         };
       })
       .attr("d", path)
      .append("title")
      .text(function(d) { return d.properties.name+": "
                         + ((wtacountry[d.properties.name] === undefined)? "0":
                           wtacountry[d.properties.name]);});

  svg.append("path")
      .datum(topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; }))
      .attr("class", "countries")
      .attr("d", path);
  };
}

function drawRank(data) {
  height = 250 - margin.top - margin.bottom;
  var y5 = d3.scaleLinear().domain([25,0]).clamp(true).range([0,height]);
  var y5Axis = d3.axisLeft(y5).ticks(5);
  var svgboxes = initcanvas("#plotboxes",250);

  svgboxes.selectAll(".ylabel")
      .text("years in pro");
  svgboxes.selectAll(".yaxis")
      .call(y5Axis);
  var boxes = svgboxes.selectAll(".rankbox")
      .data(data)
    .enter()
      .append("g")
      .attr("id",function(d) { return "rankbox"+d.id;})
      .attr("class", "rankbox")
      .on("mouseover", function(d) {
      d3.selectAll(".rankbox").style("opacity",0.15);
      d3.selectAll('.legend').style("opacity", 0);
      d3.select(this).style("opacity",1);
      d3.select("#line"+d.id)
        .style("stroke",color(1)).style("opacity",1);
      d3.select("#legend"+d.id)
        .style("opacity",1);
    })
    .on('mouseout', function(d) {
      d3.selectAll(".rankbox").style("opacity",1);
      d3.selectAll('.legend').style("opacity", 0);
      d3.selectAll('.line')
        .style("stroke","grey")
        .style("opacity", function(d) { return (d.top10 == 1)? 0.2:0;});
    })

  boxes.append("title").text(function(d) {return d.rank[0]+": "+d.name;})

  boxes.each(function(d) {
    d3.select("#rankbox"+d.id)
      .selectAll(".box")
      .data(d.rank)
      .enter()
      .append("rect")
        .attr("class","box")
        .attr("x", function(t) { return x(d.rank[0])+2; })
        .attr("y", function(t,i) { return y5(d.rank.length-i); })
        .attr("height", 8)
        .attr("width", 8)
        .attr("stroke-width", function (t) { return (t == 1)? 1:0.3;})
        .attr("stroke", "gray")
        .attr("fill", function(t) {
          if (t > 100) return d3.interpolatePurples(1-t/1000);
          else return d3.interpolateYlGnBu(t/100);
        })
    })

// legend
  for (i=0; i < 10; i++) {
    svgboxes.append("rect").attr("x", x(-1.5)).attr("y", y5(23-i*2))
        .attr("height", 8).attr("width", 8)
        .attr("stroke-width", 0.3).attr("stroke", "gray")
        .attr("fill", d3.interpolateYlGnBu(i/10));
    svgboxes.append('text').attr('x', x(-3)).attr("y", y5(22-i*2)-1).text("top "+(i*10+10))
  }

  svgboxes.append("rect").attr("x", x(-1.5)).attr("y", y5(25))
      .attr("height", 8).attr("width", 8)
      .attr("stroke-width", 0.7).attr("stroke", "black")
      .attr("fill", d3.interpolateYlGnBu(0));
  svgboxes.append('text').attr('x', x(-3)).attr("y", y5(24)-1).text("top 1")

  svgboxes.append("rect").attr("x", x(-0.8)).attr("y", y5(3))
      .attr("height", 8).attr("width", 8)
      .attr("stroke-width", 0.3).attr("stroke", "gray")
      .attr("fill", d3.interpolatePurples(0));
  svgboxes.append("rect").attr("x", x(-1.5)).attr("y", y5(3))
      .attr("height", 8).attr("width", 8)
      .attr("stroke-width", 0.3).attr("stroke", "gray")
      .attr("fill", d3.interpolatePurples(1));
  svgboxes.append('text').attr('x', x(-3)).attr("y", y5(2)-1).text("1000 to 100")


  svgRank.selectAll(".xlabel")
      .text("year");
  svgRank.selectAll(".ylabel")
      .text("rank");
  svgRank.selectAll(".xaxis")
      .call(xrAxis);
  svgRank.selectAll(".yaxis")
      .call(yrAxis);

  var line = d3.line()
    .curve(d3.curveCardinal.tension(0))
    .x(function(t) { return xr(t.y); })
    .y(function(t) { return yr(t.r); });

  var path = svgRank.selectAll(".rankline")
      .data(data)
    .enter()
      .append("g")
      .attr("fill", "none")
      .attr("class", "rankline");

  path.append("path")
      .attr("class", "line")
      .attr("id", function(d) { return 'line'+d.id;})
      .attr("d", function(d) {
        values = d.rank.map(function(x,i) {
          return { y : 2016 - i, r : x};
        });
        return line(values);
      })
    .style("stroke", "gray")
    .style("stroke-width", 3)
    .style("opacity", function(d) { return (d.top10 == 1)? 0.2:0;})
    .on("mouseover", function(d) {
      d3.selectAll(".line").transition()
         .style("opacity",function(d) { return (d.top10 == 1)? 0.2:0;});
      if (d.top10 == 1) {
        d3.selectAll('.legend').style("opacity", 0);
        d3.select(this).transition()
          .style("stroke",color(1))
          .style("opacity",1);
        d3.select("#legend"+d.id).transition()
          .style("fill",color(1)).style("opacity",1);
        d3.selectAll(".rankbox").transition().style("opacity",0.15);
        d3.select("#rankbox"+d.id).transition().style("opacity",1);
      }

    })
    .on('mouseout', function(d) {
      d3.selectAll('.line')
        .style("stroke","gray")
        .style("opacity", function(d) { return (d.top10 == 1)? 0.2:0;});
      d3.selectAll('.legend')
        .style("opacity", 0);
      d3.selectAll(".rankbox").style("opacity",1);
    })

    var legend = svgRank.selectAll('.legend').data(data)
          .enter()
          .append('g')
            .attr('class', 'legend')
            .attr('id',function(d) {return 'legend'+d.id;})
            .style('fill', color(1))
            .style("opacity",0);
    legend.append('circle')
            .attr('cx', width)
            .attr('cy', function(d, i) {return yr(d.rank[0]);})
            .attr('r', 5)
    legend.append('text')
            .attr('x', width + 5)
            .attr('y', function(d) {return yr(d.rank[0]);})
            .text(function(d) {return d.rank[0]+": "+d.name;})

}

function drawH2H(data) {

  var height = 1000;
  var x = d3.scaleLinear().domain([-2,102]).range([0, width]);
  var y = d3.scaleLinear().domain([-2,102]).range([0, height]);
  var rank = new Array();
  for (key in data) {
    rank[data[key].id]=parseInt(key);
  }
  var surface = ["CLAY","GRASS","HARD","CARPET"];

  var svg = d3.select("#h2h").append("svg")
    .attr("width", "100%")
    .attr("height", height)
    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')

  d3.queue()
    .defer(d3.json, "json/h2h.json")
    .await(ready);

  function ready(error, h2h) {
    for(key in h2h) {
      h2h[key].t1 = rank[h2h[key].t1];
      h2h[key].t2 = rank[h2h[key].t2];
      h2h[key].winner = rank[h2h[key].winner];
      h2h[key].surface = surface.indexOf(h2h[key].surface);
    }

    if (error) console.log(error);
    var boxes = svg.selectAll(".h2h")
      .data(data)
      .enter()
      .append("g")
      .attr("id",function(d) { return "h2h"+d.id;})
      .attr("class", "h2h")
    boxes.append("text")
      .attr('text-anchor', 'end')
      .attr('font-size', '8px')
      .attr('x', x(10))
      .attr('y', function(d,i) { return y(i);})
      .text(function(d) {return d.rank[0]+": "+d.name;});

    boxes.each(function(d,i) {
      var totals = [];
      var wins = [];
      var m = h2h.filter(function(h) { return (h.t1 == i || h.t2 == i);});
      for (key in m) {
        var j = (m[key].t1 == i)? m[key].t2:m[key].t1;
        if (totals[j] === undefined) totals[j] = 0;
        if (wins[j] === undefined) wins[j] = 0;
        totals[j]++;
        wins[j] = wins[j] + ((m[key].winner == i)? 1:0);
      }
      console.log(totals);

      d3.select("#h2h"+d.id)
        .selectAll(".box")
        .data(wins)
        .enter()
        .append("rect")
          .attr("class","box")
          .attr("x", function(h,j) { return x(j+11);})
          .attr("y", y(i)-6)
         .attr("height", y(i+1)-y(i)-1)
          .attr("width", x(i+1)-x(i)-1)
          .attr("stroke-width", 0.3)
          .attr("stroke", function(t){return(t === undefined)?"white":"gray";})
          .attr("fill", function(t,j) {
            if (t === undefined) return "white";
            else return d3.interpolateRdYlGn(t/totals[j]);
          })
          .on("mouseover", function() {
            d3.selectAll(".h2h").style("opacity",0.15);
            d3.selectAll("#h2h"+d.id).style("opacity",1);
             })
          .on("mouseout", function() {
            d3.selectAll(".h2h").style("opacity",1);
          })
          .append("title")
          .text(function(t,j) {
             if (t === undefined) return null;
             else return d.name+" vs. "+data[j].name+"\n"
                        +wins[j]+" - "+(totals[j]-wins[j]);});


      })


  }
}
</script>
</body>
